<!DOCTYPE html>
 <html lang="en"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title data-react-helmet="true">cerico | Nginx in Docker</title><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font-size:112.5%;line-height:1.65em;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.8);font-family:Roboto,sans-serif;font-weight:normal;word-wrap:break-word;}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;color:hsla(0,0%,0%,0.8);font-family:Roboto,sans-serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:2.25rem;line-height:2.475rem;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;color:hsla(0,0%,0%,0.8);font-family:Roboto,sans-serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:1.62671rem;line-height:2.475rem;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;color:hsla(0,0%,0%,0.8);font-family:Roboto,sans-serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:1.38316rem;line-height:1.65rem;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;color:hsla(0,0%,0%,0.8);font-family:Roboto,sans-serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.65rem;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;color:hsla(0,0%,0%,0.8);font-family:Roboto,sans-serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:0.85028rem;line-height:1.65rem;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;color:hsla(0,0%,0%,0.8);font-family:Roboto,sans-serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:0.78405rem;line-height:1.65rem;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}ul{margin-left:1.65rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;list-style-position:outside;list-style-image:none;}ol{margin-left:1.65rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;font-size:0.85rem;line-height:1.42;background:hsla(0,0%,0%,0.04);border-radius:3px;overflow:auto;padding:1.65rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;font-size:1rem;line-height:1.65rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}blockquote{margin-left:1.65rem;margin-right:1.65rem;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.65rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}b{font-weight:bold;}strong{font-weight:bold;}dt{font-weight:bold;}th{font-weight:bold;}li{margin-bottom:calc(1.65rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.65rem;margin-bottom:calc(1.65rem / 2);margin-top:calc(1.65rem / 2);}li > ul{margin-left:1.65rem;margin-bottom:calc(1.65rem / 2);margin-top:calc(1.65rem / 2);}code{font-size:0.85rem;line-height:1.65rem;}kbd{font-size:0.85rem;line-height:1.65rem;}samp{font-size:0.85rem;line-height:1.65rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:tnum;padding-left:1.1rem;padding-right:1.1rem;padding-top:0.825rem;padding-bottom:calc(0.825rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}tt,code{background-color:hsla(0,0%,0%,0.04);border-radius:3px;font-family:Consolas,"Roboto Mono","Liberation Mono",Menlo,Courier,monospace;padding:0;padding-top:0.2em;padding-bottom:0.2em;}pre code{background:none;line-height:1.42;}code:before,code:after,tt:before,tt:after{letter-spacing:-0.2em;content:"Â ";}pre code:before,pre code:after,pre tt:before,pre tt:after{content:"";}</style><link href="//fonts.googleapis.com/css?family=Roboto:400,400i,700" rel="stylesheet" type="text/css"/><style>@import url(https://fonts.googleapis.com/css?family=Raleway);.hljs{display:block;overflow-x:auto;padding:.5em;background:#000;color:#f8f8f8}.hljs-comment,.hljs-quote{color:#aeaeae;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#e28964}.hljs-string{color:#65b042}.hljs-subst{color:#daefa3}.hljs-link,.hljs-regexp{color:#e9c062}.hljs-name,.hljs-section,.hljs-tag,.hljs-title{color:#89bdff}.hljs-class .hljs-title,.hljs-doctag{text-decoration:underline}.hljs-bullet,.hljs-number,.hljs-symbol{color:#3387cc}.hljs-params,.hljs-template-variable,.hljs-variable{color:#3e87e3}.hljs-attribute{color:#cda869}.hljs-meta{color:#8996a8}.hljs-formula{background-color:#0e2231;color:#f8f8f8;font-style:italic}.hljs-addition{background-color:#253b22;color:#f8f8f8}.hljs-deletion{background-color:#420e09;color:#f8f8f8}.hljs-selector-class{color:#9b703f}.hljs-selector-id{color:#8b98ab}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}*{font-family:Fira Sans,sans-serif}body{color:#5f5c5c;font-family:PT Serif,serif;line-height:1.2em;margin:1em auto 4em;padding:0 18px;position:relative}pre{background:#000;color:#f8f8f8}pre *{font-family:Consolas,Roboto Mono,Liberation Mono,Menlo,Courier,monospace}h1,h2{text-rendering:optimizeLegibility}.inverse-topper,.topper{font-family:PT Sans,sans-serif;font-size:64px;font-weight:300;letter-spacing:-2px;line-height:1em;margin:.5em 0}.inverse-topper{color:#fff}.markdown{margin-top:23.8px;margin-top:1.7rem}body{font-family:Fira Sans,sans-serif;font-weight:300;margin:0;background:#fff;color:#3a3a3a;margin-bottom:126px;margin-bottom:9rem}header[role=banner]{background:#6495ed;padding:22px 0 0;margin-top:12px;height:112px;height:8rem;text-align:center;color:#fff}header[role=banner] h1{margin:0}header[role=banner] h3{font-size:37.8px;font-size:2.7rem}header{font-family:Raleway,sans-serif;font-weight:100;text-rendering:optimizeLegibility;line-height:1;margin-top:0}a,header{color:#6495ed}a{outline:none;transition:color .3s ease;text-decoration:none}h1{font-weight:300;font-size:70px;font-size:5rem;margin:0;font-family:Raleway,sans-serif;font-weight:100;color:#6495ed;text-rendering:optimizeLegibility}h1,h3{line-height:1}h3{font-size:37.8px;font-size:2.7rem;color:#5f5c5c;font-weight:"Fira Sans",sans-serif;font-weight:300}html{font-size:14px}article,main{display:block}.content{max-width:900px}.content,.page-content{margin:14px auto;margin:1rem auto}.page-content{max-width:720px}.post{position:relative;width:80%;margin:42px auto;margin:3rem auto;padding-bottom:42px;padding-bottom:3rem;border-bottom:1px solid #ccc;word-break:break-word;-webkit-hyphens:auto;-ms-hyphens:auto;hyphens:auto}.post-meta{display:inline-block;margin:0 0 5px;font-size:28px;font-size:2rem;color:#9eabb3}.post-meta a{color:#9eabb3;text-decoration:none}.post-title{margin:0;color:#6495ed}h2{font-size:56px;font-size:4rem}section{max-width:960px;margin:auto}.post-excerpt p{margin:22.4px 0 0;margin:1.6rem 0 0;line-height:22.4px;line-height:1.6rem}dl,ol,p,ul{margin:22.4px 0;margin:1.6rem 0;font-size:17.92px;font-size:1.28rem;line-height:1.6}header h1,header h3{color:#fff}</style></head><body><div id="react-mount"><div data-reactroot="" data-reactid="1" data-react-checksum="1669500390"><div class="headroom-wrapper" data-reactid="2"><div style="position:relative;top:0;left:0;right:0;z-index:1;-webkit-transform:translateY(0);-ms-transform:translateY(0);transform:translateY(0);" class="headroom headroom--unfixed" data-reactid="3"><header role="banner" data-reactid="4"><a class="inverse-topper" href="/" data-reactid="5">cerico</a></header></div></div><div style="margin-left:2%;" data-reactid="6"><p style="margin-bottom:0.33rem;" data-reactid="7"><a href="/about/" data-reactid="8"><img src="https://s3.eu-west-2.amazonaws.com/io1937/ghpages/linkedin.jpg" style="float:left;margin-top:0;margin-bottom:0;margin-right:0.4125rem;width:3.3rem;height:3.3rem;border-radius:50%;border:1px gray solid;" data-reactid="9"/></a><span data-reactid="10"><!-- react-text: 11 -->garethrobertlee<!-- /react-text --><a href="/about/" data-reactid="12"></a></span></p><div data-reactid="13"><div data-reactid="14"><span data-reactid="15"><a href="/" data-reactid="16">Posts | </a><a href="/about/" data-reactid="17">About | </a></span><a href="mailto:garethrobertlee@gmail.com?Subject=Hello" target="blank_" data-reactid="18">Contact</a></div></div></div><div class="markdown page-content" data-reactid="19"><!-- react-empty: 20 --><div data-reactid="21"><div style="font-size:2rem;color:#9EABB3;margin-bottom:1px;text-align:center;" data-reactid="22"><!-- react-text: 23 -->21 Aug 2017<!-- /react-text --><!-- react-text: 24 --> in <!-- /react-text --><span style="display:inline;" data-reactid="25"><span style="margin-right:8px;line-height:1.5;" data-reactid="26"><a style="color:rgb(158, 171, 179);display:inline-block;" href="/tags/#docker" data-reactid="27">Docker</a><span data-reactid="28">,</span></span><span style="margin-right:8px;line-height:1.5;" data-reactid="29"><a style="color:rgb(158, 171, 179);display:inline-block;" href="/tags/#nginx" data-reactid="30">Nginx</a><span data-reactid="31"></span></span></span></div></div><h1 style="font-size:4rem;margin-bottom:1rem;margin-top:2rem;" data-reactid="32">Nginx in Docker</h1><div data-reactid="33"><p>The nginx/proxy container serves two purposes. Firstly it will handle requests from the web (port 80/443) and then send those requests to the appropiate container. But secondly it will handle requests <em>between</em> containers. In our case weâll have a client container that will need to make requests to the Clojure API container. As they are running on different ports weâll run into CORS errors (where requests from a different domain are automatically dropped). Rather than fiddle about trying to get CORS whitelisting happening within the server container, we can use the nginx container - a cleaner solution.</p>
<hr>
<h3>TLDR / Repo</h3>
<p>Repository is here <a href="https://github.com/institute1937/marsden">https://github.com/institute1937/marsden</a></p>
<hr>
<h3>Pages</h3>
<ul>
<li><a href="../2017-08-17---dockerize-i-intro/">Part One - Intro</a></li>
<li><a href="../2017-08-18---dockerize-ii-dockerfiles/">Part Two - Dockerfiles</a></li>
<li>Part Three - Nginx</li>
<li><a href="../2017-08-21---dockerize-iv-client-container/">Part Four - Client App</a></li>
<li><a href="../2017-08-21---dockerize-v-clojure-container/">Part Five - Server App</a></li>
<li><a href="../2017-08-21---dockerize-vi-provision-exoscale/">Part Six - Provisioning</a></li>
<li><a href="../2017-08-23---dockerize-vii-connect-existing-machine/">Part Seven - Connect Existing</a></li>
<li>Part Eight - Ansible - soon</li>
</ul>
<hr>
<h3>Client</h3>
<pre><code>â  marsden git:(master) cat <span class="hljs-keyword">client</span>/<span class="hljs-keyword">server</span>.js
</code></pre>
<pre><code><span class="hljs-keyword">var</span> path = <span class="hljs-keyword">require</span>(<span class="hljs-string">'path'</span>)
<span class="hljs-keyword">var</span> express = <span class="hljs-keyword">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">var</span> server = express();

server.<span class="hljs-keyword">use</span>(express.<span class="hljs-keyword">static</span>(<span class="hljs-string">'.'</span>));
console.log(process.env.PORT)
server.<span class="hljs-keyword">use</span>(express.<span class="hljs-keyword">static</span>(path.join(__dirname, <span class="hljs-string">'./dist'</span>)));
server.listen(process.env.PORT || <span class="hljs-number">5000</span>);
</code></pre>
<hr>
<h3>Server</h3>
<pre><code>â  marsden <span class="hljs-string">git:</span>(master) â cat clojure<span class="hljs-regexp">/src/</span>hidere/core.clj
</code></pre>
<pre><code>(<span class="hljs-name"><span class="hljs-builtin-name">ns</span></span> hidere.core
  (<span class="hljs-symbol">:use</span> [org.httpkit.server] [clojure.data.json <span class="hljs-symbol">:only</span> [json-str]])
  (<span class="hljs-symbol">:gen-class</span>))

(<span class="hljs-name"><span class="hljs-builtin-name">defn</span></span> say-hello [request]
  {<span class="hljs-symbol">:status</span> <span class="hljs-number">200</span>
   <span class="hljs-symbol">:headers</span> {<span class="hljs-string">"Content-Type"</span> <span class="hljs-string">"application/json"</span>}
   <span class="hljs-symbol">:body</span>    (<span class="hljs-name">json-str</span> {<span class="hljs-string">"message"</span> <span class="hljs-string">"and I'm from Clojure"</span>})})

(<span class="hljs-name"><span class="hljs-builtin-name">use</span></span> 'ring.adapter.jetty)

(<span class="hljs-name">run-jetty</span> say-hello {<span class="hljs-symbol">:port</span> <span class="hljs-number">3009</span>})
</code></pre>
<p>We can see that our client app is running on port 5000 and our clojure app on port 3009. If we wanted to, we could also run them individually, bypassing nginx and docker altogether, which weâll look at in the next couple of posts.</p>
<hr>
<h3>API Request</h3>
<pre><code>â  marsden gi<span class="hljs-variable">t:</span>(master) â <span class="hljs-keyword">cat</span> client/src/js/<span class="hljs-built_in">index</span>.js
</code></pre>
<pre><code>  <span class="hljs-keyword">const</span> host = <span class="hljs-built_in">window</span>.location.host

  <span class="hljs-keyword">const</span> API = <span class="hljs-string">'http://'</span> + host + <span class="hljs-string">'/clojure'</span>;
  fetch(API).then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">res</span>)</span>{
</code></pre>
<p>Truncated output here as weâll look at this in more detail later, all we really need to know right now is that the client app is going to make a request to the clojure API - and then it doesnât request this on a separate port. It doesnât even know about any other ports.</p>
<hr>
<h3>Nginx</h3>
<p>Letâs look back at our nginx dockerfile</p>
<pre><code>â  marsden gi<span class="hljs-variable">t:</span>(master) â <span class="hljs-keyword">cat</span> proxy/Dockerfile
</code></pre>
<pre><code><span class="hljs-keyword">FROM</span> nginx

<span class="hljs-keyword">COPY</span><span class="bash"> default.conf /etc/nginx/conf.d/default.conf
</span><span class="hljs-keyword">COPY</span><span class="bash"> nginx.conf /etc/nginx/nginx.conf
</span><span class="hljs-keyword">COPY</span><span class="bash"> sites-enabled/* /etc/nginx/sites-enabled/
</span><span class="hljs-keyword">COPY</span><span class="bash"> index.html /usr/share/nginx/html
</span></code></pre>
<p>Weâre going to copy 4 files into the container. Letâs go through each of them.</p>
<hr>
<h3>nginx.conf</h3>
<pre><code>â  marsden gi<span class="hljs-variable">t:</span>(master) â <span class="hljs-keyword">cat</span> proxy/nginx.<span class="hljs-keyword">conf</span>
</code></pre>
<pre><code>events{

}

http {
  <span class="hljs-keyword">include</span> <span class="hljs-regexp">/etc/</span>nginx<span class="hljs-regexp">/conf.d/</span>*.conf;
  <span class="hljs-keyword">include</span> <span class="hljs-regexp">/etc/</span>nginx<span class="hljs-regexp">/sites-enabled/</span>*;
}
</code></pre>
<p>This is the nginx entry point, all this is going to do is include a default file, and then any conf files for sites that are enabled - in our case we have two - mars production, and mars dev.</p>
<pre><code>â  marsden <span class="hljs-string">git:</span>(master) â ls proxy<span class="hljs-regexp">/sites-enabled/</span>
</code></pre>
<pre><code>mars<span class="hljs-selector-class">.conf</span>     mars<span class="hljs-selector-class">.dev</span><span class="hljs-selector-class">.conf</span>
</code></pre>
<p>All files here are aggregated into the main nginx.conf file, so no duplication in these files is permitted.</p>
<hr>
<h3>Sites Enabled files</h3>
<pre><code>â  marsden gi<span class="hljs-variable">t:</span>(master) <span class="hljs-keyword">cat</span> proxy/sites-enabled/mars.<span class="hljs-keyword">conf</span>
</code></pre>
<pre><code><span class="hljs-attribute">upstream</span> front {
    <span class="hljs-attribute">server</span> web:<span class="hljs-number">5000</span>;
}

<span class="hljs-attribute">upstream</span> back {
    <span class="hljs-attribute">server</span> clojure:<span class="hljs-number">3009</span>;
}

<span class="hljs-section">server</span> {
    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;
    <span class="hljs-attribute">server_name</span> mars.io37.ml mars.io37.cf mars.cuya.ml;
    <span class="hljs-attribute">location</span> / {
        <span class="hljs-attribute">proxy_pass</span> http://front;
    }
    <span class="hljs-attribute">location</span> /clojure {
        <span class="hljs-attribute">proxy_pass</span>   http://back;
    }
}
</code></pre>
<pre><code>â  marsden git:(master) cat proxy/sites-enabled/mars<span class="hljs-selector-class">.dev</span><span class="hljs-selector-class">.conf</span>
</code></pre>
<pre><code><span class="hljs-section">server</span> {
    <span class="hljs-attribute">listen</span> <span class="hljs-number">3100</span>;
    <span class="hljs-attribute">location</span> / {
        <span class="hljs-attribute">proxy_pass</span> http://front;
    }
    <span class="hljs-attribute">location</span> /clojure {
        <span class="hljs-attribute">proxy_pass</span>   http://back;
    }
}
</code></pre>
<p>Weâll start with the dev file as weâl be running locally first. When we run âmake startâ or âdocker-compose upâ to launch the application, it will listen on port 3100 (<a href="http://localhost:3100">http://localhost:3100</a>). If we go to <a href="http://localhost:3100/">http://localhost:3100/</a> we should see the</p>
<p><img src="https://s3.eu-west-2.amazonaws.com/io1937/ghpages/3100.png" alt="3100"></p>
<p>We make a request for / on port 3100, and nginx makes a request on port 5000, which is where the client app is running (upstream front). The client app makes a request for /clojure, also on 3100 and nginx requests on port 3009 where the clojure app is running (upsteam back).</p>
<p>We can make this request directly if we like.</p>
<p><img src="https://s3.eu-west-2.amazonaws.com/io1937/ghpages/3100clj.png" alt="3100clj"></p>
<p>Here we are requesting the api /clojure directly, nginx fetches it for us and hands it directly to us in the browser</p>
<p>We can also access each container directly, for troubleshooting. If we remember back to our main docker-compose.yml.</p>
<pre><code>â  <span class="hljs-selector-tag">marsden</span> <span class="hljs-selector-tag">git</span><span class="hljs-selector-pseudo">:(master)</span> â <span class="hljs-selector-tag">cat</span> <span class="hljs-selector-tag">docker-compose</span><span class="hljs-selector-class">.yml</span>
</code></pre>
<pre><code><span class="hljs-attribute">version</span>: <span class="hljs-string">"2"</span>
<span class="hljs-attribute">services</span>:

    <span class="hljs-attribute">web</span>:
        <span class="hljs-attribute">build</span>:
          <span class="hljs-attribute">context</span>: ./client
          <span class="hljs-attribute">dockerfile</span>: Dockerfile.dev
        <span class="hljs-attribute">volumes</span>:
          - <span class="hljs-string">"./client:/build"</span>
          - /build/node_modules
        <span class="hljs-attribute">working_dir</span>: /build
        <span class="hljs-attribute">command</span>: <span class="hljs-string">'npm run dev'</span>
        <span class="hljs-attribute">ports</span>:
          - <span class="hljs-number">6800</span>:<span class="hljs-number">5000</span>

    <span class="hljs-attribute">clojure</span>:
        <span class="hljs-attribute">build</span>: ./clojure
        <span class="hljs-attribute">volumes</span>:
          - <span class="hljs-string">"./clojure:/build"</span>
        <span class="hljs-attribute">working_dir</span>: /build
        <span class="hljs-attribute">command</span>: <span class="hljs-string">'lein run'</span>
        <span class="hljs-attribute">ports</span>:
          - <span class="hljs-number">6801</span>:<span class="hljs-number">3009</span>

    <span class="hljs-attribute">nginx</span>:
        <span class="hljs-attribute">build</span>: ./proxy
        <span class="hljs-attribute">ports</span>:
            - <span class="hljs-string">"3100:3100"</span>
        <span class="hljs-attribute">links</span>:
            - web
            - clojure
</code></pre>
<p>Nginx accesses both containers by their internal ports, 5000 and 3009. But via the docker-compose port mapping we can also do the same, by their externally mapped ports 6800 and 6801</p>
<p><img src="https://s3.eu-west-2.amazonaws.com/io1937/ghpages/6800.png" alt="6800"></p>
<p><img src="https://s3.eu-west-2.amazonaws.com/io1937/ghpages/6801.png" alt="6801"></p>
<p>But here we can see that the client app isnât able to connect to the api /clojure endpoint without nginx. We can also see if we try and connect directly to it on that port.</p>
<p><img src="https://s3.eu-west-2.amazonaws.com/io1937/ghpages/no.png" alt="no"></p>
<hr>
<h3>default.conf</h3>
<p>Weâre not using this file in development, so weâll come back to this when we push to production, but lets take a quick look</p>
<pre><code><span class="hljs-section">server</span> { 
    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>; 
    <span class="hljs-attribute">root</span> /usr/share/nginx/html;
    <span class="hljs-attribute">server_name</span> <span class="hljs-regexp">*.io</span>37.ml <span class="hljs-regexp">*.io</span>37.cf;
    <span class="hljs-attribute">location</span> / { 
        <span class="hljs-attribute">index</span> index.html;
    } 
}
</code></pre>
<p>Here we will listen for any url not explicitly named in any of the sites-enabled/*.conf files. Essentially its a catch for mistyped urls. In our case it loads a one word index.html</p>
<pre><code>â  marsden gi<span class="hljs-variable">t:</span>(master) â <span class="hljs-keyword">cat</span> proxy/<span class="hljs-built_in">index</span>.html
Mars!
</code></pre>
<h3>Next</h3>
<p><a href="../2017-08-21---dockerize-iv-client-container/">Part Four - Client App</a></p>
</div><div data-reactid="34"><span style="display:inline;" data-reactid="35"><span style="margin-right:8px;line-height:1.5;" data-reactid="36"><a style="color:rgb(158, 171, 179);display:inline-block;" href="/tags/#docker" data-reactid="37">Docker</a><span data-reactid="38">,</span></span><span style="margin-right:8px;line-height:1.5;" data-reactid="39"><a style="color:rgb(158, 171, 179);display:inline-block;" href="/tags/#nginx" data-reactid="40">Nginx</a><span data-reactid="41"></span></span></span><hr style="margin-top:1.07rem;" data-reactid="42"/><p style="margin-bottom:0.33rem;" data-reactid="43"><a href="/about/" data-reactid="44"><img src="https://s3.eu-west-2.amazonaws.com/io1937/ghpages/linkedin.jpg" style="float:left;margin-top:0;margin-bottom:0;margin-right:0.4125rem;width:3.3rem;height:3.3rem;border-radius:50%;border:1px gray solid;" data-reactid="45"/></a><span data-reactid="46"><!-- react-text: 47 -->garethrobertlee<!-- /react-text --><a href="/about/" data-reactid="48"></a></span></p><div data-reactid="49"><div data-reactid="50"><span data-reactid="51"><a href="/" data-reactid="52">Posts | </a><a href="/about/" data-reactid="53">About | </a></span><a href="mailto:garethrobertlee@gmail.com?Subject=Hello" target="blank_" data-reactid="54">Contact</a></div></div></div></div></div></div><script src="/bundle.js?t=1504531353694"></script></body></html>