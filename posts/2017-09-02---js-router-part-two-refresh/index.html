<!DOCTYPE html>
 <html lang="en"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title data-react-helmet="true">cerico | JS Router Part Two - Refresh</title><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font-size:112.5%;line-height:1.65em;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.8);font-family:Roboto,sans-serif;font-weight:normal;word-wrap:break-word;}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;color:hsla(0,0%,0%,0.8);font-family:Roboto,sans-serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:2.25rem;line-height:2.475rem;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;color:hsla(0,0%,0%,0.8);font-family:Roboto,sans-serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:1.62671rem;line-height:2.475rem;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;color:hsla(0,0%,0%,0.8);font-family:Roboto,sans-serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:1.38316rem;line-height:1.65rem;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;color:hsla(0,0%,0%,0.8);font-family:Roboto,sans-serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.65rem;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;color:hsla(0,0%,0%,0.8);font-family:Roboto,sans-serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:0.85028rem;line-height:1.65rem;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;color:hsla(0,0%,0%,0.8);font-family:Roboto,sans-serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:0.78405rem;line-height:1.65rem;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}ul{margin-left:1.65rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;list-style-position:outside;list-style-image:none;}ol{margin-left:1.65rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;font-size:0.85rem;line-height:1.42;background:hsla(0,0%,0%,0.04);border-radius:3px;overflow:auto;padding:1.65rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;font-size:1rem;line-height:1.65rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}blockquote{margin-left:1.65rem;margin-right:1.65rem;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.65rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}b{font-weight:bold;}strong{font-weight:bold;}dt{font-weight:bold;}th{font-weight:bold;}li{margin-bottom:calc(1.65rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.65rem;margin-bottom:calc(1.65rem / 2);margin-top:calc(1.65rem / 2);}li > ul{margin-left:1.65rem;margin-bottom:calc(1.65rem / 2);margin-top:calc(1.65rem / 2);}code{font-size:0.85rem;line-height:1.65rem;}kbd{font-size:0.85rem;line-height:1.65rem;}samp{font-size:0.85rem;line-height:1.65rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:tnum;padding-left:1.1rem;padding-right:1.1rem;padding-top:0.825rem;padding-bottom:calc(0.825rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}tt,code{background-color:hsla(0,0%,0%,0.04);border-radius:3px;font-family:Consolas,"Roboto Mono","Liberation Mono",Menlo,Courier,monospace;padding:0;padding-top:0.2em;padding-bottom:0.2em;}pre code{background:none;line-height:1.42;}code:before,code:after,tt:before,tt:after{letter-spacing:-0.2em;content:" ";}pre code:before,pre code:after,pre tt:before,pre tt:after{content:"";}</style><link href="//fonts.googleapis.com/css?family=Roboto:400,400i,700" rel="stylesheet" type="text/css"/><style>@import url(https://fonts.googleapis.com/css?family=Raleway);.hljs{display:block;overflow-x:auto;padding:.5em;background:#000;color:#f8f8f8}.hljs-comment,.hljs-quote{color:#aeaeae;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#e28964}.hljs-string{color:#65b042}.hljs-subst{color:#daefa3}.hljs-link,.hljs-regexp{color:#e9c062}.hljs-name,.hljs-section,.hljs-tag,.hljs-title{color:#89bdff}.hljs-class .hljs-title,.hljs-doctag{text-decoration:underline}.hljs-bullet,.hljs-number,.hljs-symbol{color:#3387cc}.hljs-params,.hljs-template-variable,.hljs-variable{color:#3e87e3}.hljs-attribute{color:#cda869}.hljs-meta{color:#8996a8}.hljs-formula{background-color:#0e2231;color:#f8f8f8;font-style:italic}.hljs-addition{background-color:#253b22;color:#f8f8f8}.hljs-deletion{background-color:#420e09;color:#f8f8f8}.hljs-selector-class{color:#9b703f}.hljs-selector-id{color:#8b98ab}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}*{font-family:Fira Sans,sans-serif}body{color:#5f5c5c;font-family:PT Serif,serif;line-height:1.2em;margin:1em auto 4em;padding:0 18px;position:relative}pre{background:#000;color:#f8f8f8}pre *{font-family:Consolas,Roboto Mono,Liberation Mono,Menlo,Courier,monospace}h1,h2{text-rendering:optimizeLegibility}.inverse-topper,.topper{font-family:PT Sans,sans-serif;font-size:64px;font-weight:300;letter-spacing:-2px;line-height:1em;margin:.5em 0}.inverse-topper{color:#fff}.markdown{margin-top:23.8px;margin-top:1.7rem}body{font-family:Fira Sans,sans-serif;font-weight:300;margin:0;background:#fff;color:#3a3a3a;margin-bottom:126px;margin-bottom:9rem}header[role=banner]{background:#6495ed;padding:22px 0 0;margin-top:12px;height:112px;height:8rem;text-align:center;color:#fff}header[role=banner] h1{margin:0}header[role=banner] h3{font-size:37.8px;font-size:2.7rem}header{font-family:Raleway,sans-serif;font-weight:100;text-rendering:optimizeLegibility;line-height:1;margin-top:0}a,header{color:#6495ed}a{outline:none;transition:color .3s ease;text-decoration:none}h1{font-weight:300;font-size:70px;font-size:5rem;margin:0;font-family:Raleway,sans-serif;font-weight:100;color:#6495ed;text-rendering:optimizeLegibility}h1,h3{line-height:1}h3{font-size:37.8px;font-size:2.7rem;color:#5f5c5c;font-weight:"Fira Sans",sans-serif;font-weight:300}html{font-size:14px}article,main{display:block}.content{max-width:900px}.content,.page-content{margin:14px auto;margin:1rem auto}.page-content{max-width:720px}.post{position:relative;width:80%;margin:42px auto;margin:3rem auto;padding-bottom:42px;padding-bottom:3rem;border-bottom:1px solid #ccc;word-break:break-word;-webkit-hyphens:auto;-ms-hyphens:auto;hyphens:auto}.post-meta{display:inline-block;margin:0 0 5px;font-size:28px;font-size:2rem;color:#9eabb3}.post-meta a{color:#9eabb3;text-decoration:none}.post-title{margin:0;color:#6495ed}h2{font-size:56px;font-size:4rem}section{max-width:960px;margin:auto}.post-excerpt p{margin:22.4px 0 0;margin:1.6rem 0 0;line-height:22.4px;line-height:1.6rem}dl,ol,p,ul{margin:22.4px 0;margin:1.6rem 0;font-size:17.92px;font-size:1.28rem;line-height:1.6}ol,ul{margin-left:22.4px!important;margin-left:1.6rem!important}header h1,header h3{color:#fff}</style></head><body><div id="react-mount"><div data-reactroot="" data-reactid="1" data-react-checksum="1397378006"><div class="headroom-wrapper" data-reactid="2"><div style="position:relative;top:0;left:0;right:0;z-index:1;-webkit-transform:translateY(0);-ms-transform:translateY(0);transform:translateY(0);" class="headroom headroom--unfixed" data-reactid="3"><header role="banner" data-reactid="4"><a class="inverse-topper" href="/" data-reactid="5">cerico</a></header></div></div><div style="margin-left:2%;" data-reactid="6"><p style="margin-bottom:0.33rem;" data-reactid="7"><a href="/about/" data-reactid="8"><img src="https://s3.eu-west-2.amazonaws.com/io1937/ghpages/linkedin.jpg" style="float:left;margin-top:0;margin-bottom:0;margin-right:0.4125rem;width:3.3rem;height:3.3rem;border-radius:50%;border:1px gray solid;" data-reactid="9"/></a><span data-reactid="10"><!-- react-text: 11 -->garethrobertlee<!-- /react-text --><a href="/about/" data-reactid="12"></a></span></p><div data-reactid="13"><div data-reactid="14"><span data-reactid="15"><a href="/" data-reactid="16">Posts | </a><a href="/about/" data-reactid="17">About | </a></span><a href="mailto:garethrobertlee@gmail.com?Subject=Hello" target="blank_" data-reactid="18">Contact</a></div></div></div><div class="markdown page-content" data-reactid="19"><!-- react-empty: 20 --><div data-reactid="21"><div style="font-size:2rem;color:#9EABB3;margin-bottom:1px;text-align:center;" data-reactid="22"><!-- react-text: 23 -->2 Sep 2017<!-- /react-text --><!-- react-text: 24 --> in <!-- /react-text --><span style="display:inline;" data-reactid="25"><span style="margin-right:8px;line-height:1.5;" data-reactid="26"><a style="color:rgb(158, 171, 179);display:inline-block;" href="/tags/#javascript" data-reactid="27">Javascript</a><span data-reactid="28">,</span></span><span style="margin-right:8px;line-height:1.5;" data-reactid="29"><a style="color:rgb(158, 171, 179);display:inline-block;" href="/tags/#es6" data-reactid="30">ES6</a><span data-reactid="31"></span></span></span></div></div><h1 style="font-size:4rem;margin-bottom:1rem;margin-top:2rem;" data-reactid="32">JS Router Part Two - Refresh</h1><div data-reactid="33"><p>In part 1, our client side router works fine, and loads our html but our URL doesn’t update, which means we don’t have a unique address for any of our pages, we’re always at the root URL. Today we’re going to flesh out our router using pushState and HTML5’s history facility.</p>
<hr>
<h3>Pre-requisites.</h3>
<p><a href="../2017-08-26---javascript-router/">Part One</a></p>
<hr>
<h3>Updating URL</h3>
<p>There are two main ways to do this, with either hashbang URLs (eg <a href="http://url.com/#hereford">url.com/#hereford</a>), or using pushState, which gives us a standard looking URL. Lets be honest, those hashbang URL’s don’t feel very solid! With pushState a client rendered URL will look the same as a server rendered one.</p>
<pre><code>➜  how-<span class="hljs-keyword">to</span>-js-router gi<span class="hljs-variable">t:</span>(six) ✗ <span class="hljs-keyword">cat</span> src/js/delph.js
</code></pre>
<pre><code><span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Delph</span> </span>{
    
    <span class="hljs-keyword">constructor</span>(routes,el){
        <span class="hljs-keyword">this</span>.routes = routes
        <span class="hljs-keyword">this</span>.el = el
    }

    load(page){ 
        
        history.pushState({ page}, <span class="hljs-literal">null</span>, <span class="hljs-string">`/<span class="hljs-subst">${page}</span>`</span>);
        <span class="hljs-keyword">let</span> route =  <span class="hljs-keyword">this</span>.routes[page];
        route.load().then(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> route.show(<span class="hljs-keyword">this</span>.el));
    }
}
</code></pre>
<p>Here we are taking the HTML5 history api and into it we push our page object, page title (null), and page url.</p>
<p><img src="https://dl.dropboxusercontent.com/s/imbm5wdf8xv7s5b/9CE60511-B1A8-4096-A439-25F2E48F5E9B-567-00000F28303615AF.gif?dl=0" alt="alt text" title="update url"></p>
<p>Repo at stage 6: <a href="https://github.com/cerico/how-to-js-router/releases/tag/0.6">https://github.com/cerico/how-to-js-router/releases/tag/0.6</a></p>
<hr>
<h3>Handling refresh and direct linking</h3>
<p>We’re now updating the URL as part of the router’s load function, which is only run when we click on a link. But what happens if we go to a link directly, or refresh the page. We just get the index page again, but why is this?</p>
<p>Its down to our webpack configuration, and specifically where we us historyApiFallback and rewrites. Whats actually happening is <em>whatever</em> url we put in on first load - is going to give us the index.html page - and any javascript that runs on page load. Updating the URL and changing the content are actually <em>unrelated</em> events that both happen in the routers load function, and when we go to a page directly, the URL may look right, but we’re not telling our router to load any content.</p>
<p>So we want our router’s load function to fetch the right page on page load. We can do this by grabbing the URL on initialization of the router, and passing it to the load function</p>
<pre><code>➜  how-<span class="hljs-keyword">to</span>-js-router gi<span class="hljs-variable">t:</span>(seven) <span class="hljs-keyword">cat</span> -n src/js/<span class="hljs-built_in">index</span>.js
</code></pre>
<pre><code>   ...
     <span class="hljs-number">4</span>	<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Index</span> </span>{
     <span class="hljs-number">5</span>
     <span class="hljs-number">6</span>	    <span class="hljs-keyword">constructor</span>(){
     <span class="hljs-number">7</span>	      <span class="hljs-keyword">const</span> page = <span class="hljs-built_in">window</span>.location.pathname.substr(<span class="hljs-number">1</span>) || <span class="hljs-string">''</span>
     <span class="hljs-number">8</span>	      <span class="hljs-keyword">let</span> main = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'main'</span>)
     <span class="hljs-number">9</span>	      <span class="hljs-keyword">this</span>.delph = <span class="hljs-keyword">new</span> Delph(routes, main, page)
    <span class="hljs-number">10</span>	      <span class="hljs-keyword">this</span>.makeHeader(routes)
    <span class="hljs-number">11</span>	    }
    ...
</code></pre>
<p>We can grab the route we want from the URL (line 7), which will give us e.g ‘hereford’, ‘glossop’ or in the case of the root url - nothing, in which case we’ll use an empty string. We can then pass this to our router (line 9)</p>
<pre><code>➜  how-<span class="hljs-keyword">to</span>-js-router gi<span class="hljs-variable">t:</span>(seven) ✗ <span class="hljs-keyword">cat</span> src/js/delph.js
</code></pre>
<pre><code><span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Delph</span> </span>{

    <span class="hljs-keyword">constructor</span>(routes,el,page){
        <span class="hljs-keyword">this</span>.routes = routes;
        <span class="hljs-keyword">this</span>.el = el;
        <span class="hljs-keyword">this</span>.load(page)
    }

    load(page){
        history.pushState({ page}, <span class="hljs-literal">null</span>, <span class="hljs-string">`/<span class="hljs-subst">${page}</span>`</span>);
        <span class="hljs-keyword">let</span> route =  <span class="hljs-keyword">this</span>.routes[page];
        route.load().then(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> route.show(<span class="hljs-keyword">this</span>.el));
    }
}
</code></pre>
<p>We can pick up the page pathname string here, and pass to the load function when initiated. Our named pages will now work with direct links and with refreshes. But now the function runs on page load, how do we handle the index route. And what about handling 404s?</p>
<p>Repo at stage 7: <a href="https://github.com/cerico/how-to-js-router/releases/tag/0.7">https://github.com/cerico/how-to-js-router/releases/tag/0.7</a></p>
<hr>
<h3>Index Route</h3>
<p>The main issue for the router now, is regarding the index route. Firstly, there isn’t one in our routes object, so there’s nothing to load. But what do we call it, as the pathname of the index route is going to be an empty string, and we have to call its html file <em>something</em>. Lets call it default, for now.</p>
<pre><code>➜  how-<span class="hljs-keyword">to</span>-js-router gi<span class="hljs-variable">t:</span>(eight) ✗ <span class="hljs-keyword">cat</span> src/js/routes.js
</code></pre>
<pre><code><span class="hljs-keyword">import</span> { Page } <span class="hljs-keyword">from</span> <span class="hljs-string">'./page'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> routes = {
    <span class="hljs-attr">glossop</span>: <span class="hljs-keyword">new</span> Page(<span class="hljs-string">'glossop'</span>),
    <span class="hljs-attr">kendal</span>:  <span class="hljs-keyword">new</span> Page(<span class="hljs-string">'kendal'</span>),
    <span class="hljs-attr">hereford</span>:  <span class="hljs-keyword">new</span> Page(<span class="hljs-string">'hereford'</span>),
    <span class="hljs-attr">malton</span>:  <span class="hljs-keyword">new</span> Page(<span class="hljs-string">'malton'</span>),
    <span class="hljs-string">''</span> : <span class="hljs-keyword">new</span> Page(<span class="hljs-string">'default'</span>)
}
</code></pre>
<p>And create a default view for it to load - and we’ll create the 404 view at the same time.</p>
<pre><code>➜  how-to-js-router git:(eight) ✗ cat src/views/default<span class="hljs-selector-class">.html</span>
<span class="hljs-selector-tag">i</span> am m the homepage
</code></pre>
<p>But as the text for the link for the default route is just an empty string, we have nothing to click on.</p>
<pre><code> how-<span class="hljs-keyword">to</span>-js-router gi<span class="hljs-variable">t:</span>(eight) ✗ <span class="hljs-keyword">cat</span> -n src/js/<span class="hljs-built_in">index</span>.js
</code></pre>
<pre><code>    ...
    <span class="hljs-number">13</span>	    makeHeader(routes){
    <span class="hljs-number">14</span>	      <span class="hljs-keyword">let</span> el = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'header'</span>)
    <span class="hljs-number">15</span>	      <span class="hljs-built_in">Object</span>.keys(routes).map(<span class="hljs-function"><span class="hljs-params">route</span> =&gt;</span> {
    <span class="hljs-number">16</span>	        <span class="hljs-keyword">let</span> e = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">"li"</span>);
    <span class="hljs-number">17</span>	        e.innerHTML = route || <span class="hljs-string">"index"</span>
    ...
</code></pre>
<p>So in the case of an our named route being an empty string, we can just use ‘index’ for the text of the link, but still pass the load function the ‘real’ empty string, to tally up with the routes object.</p>
<p>Repo at stage 8: <a href="https://github.com/cerico/how-to-js-router/releases/tag/0.8">https://github.com/cerico/how-to-js-router/releases/tag/0.8</a></p>
<hr>
<h3>404</h3>
<p>Now the index route is fixed, but the router breaks if we type in the wrong pathname, we have no 404. Simple enough to fix, we need a 404 html file, and a catch in the router’s load function, to show it when a named route can’t be found.</p>
<pre><code>➜  how-<span class="hljs-keyword">to</span>-js-router gi<span class="hljs-variable">t:</span>(nine) ✗ <span class="hljs-keyword">cat</span> src/js/delph.js
</code></pre>
<pre><code><span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Delph</span> </span>{
    
    <span class="hljs-keyword">constructor</span>(routes,el,page){
        <span class="hljs-keyword">this</span>.routes = routes;
        <span class="hljs-keyword">this</span>.el = el;
        <span class="hljs-keyword">this</span>.load(page)
    }

    load(page){
        history.pushState({ page}, <span class="hljs-literal">null</span>, <span class="hljs-string">`/<span class="hljs-subst">${page}</span>`</span>);
        <span class="hljs-built_in">console</span>.log(page)
        <span class="hljs-keyword">let</span> route =  <span class="hljs-keyword">this</span>.routes[page];
        <span class="hljs-keyword">if</span> (route) {
            route.load().then(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> route.show(<span class="hljs-keyword">this</span>.el));
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">this</span>.el.innerHTML = <span class="hljs-string">"no page found"</span>
        }
    }
}
</code></pre>
<p>If we’re unable to find a route in the routes object(due to mistyped link), we can simply attach an error message to the element</p>
<p>Repo at stage 9: <a href="https://github.com/cerico/how-to-js-router/releases/tag/0.9">https://github.com/cerico/how-to-js-router/releases/tag/0.9</a></p>
<hr>
<h3>The Back Button</h3>
<p>Try clicking the back button…and nothing happens. And people really love the back button! The URL updates, but the content doesn’t change</p>
<p>vid</p>
<p>If we remember from before, the URL updating and the content loading are unrelated events that both happen during the router’s load function, giving the appearance of being connected. The URL changing is part of HTML5’s History API, so lets hook into that and change the content whenever it updates.</p>
<pre><code>➜  how-<span class="hljs-keyword">to</span>-js-router gi<span class="hljs-variable">t:</span>(ten) <span class="hljs-keyword">cat</span> -n src/js/delph.js
</code></pre>
<pre><code>     <span class="hljs-number">1</span>	export class Delph {
     <span class="hljs-number">2</span>
     <span class="hljs-number">3</span>	  constructor(routes,el,page){
     <span class="hljs-number">4</span>	    this.routes = routes;
     <span class="hljs-number">5</span>	    this.el = el;
     <span class="hljs-number">6</span>	    this.load(page)
     <span class="hljs-number">7</span>	    this.handleBackButton()
     <span class="hljs-number">8</span>	  }
     <span class="hljs-number">9</span>
    <span class="hljs-number">10</span>	  handleBackButton(){
    <span class="hljs-number">11</span>	    window.onpopstate = () =&gt; {
    <span class="hljs-number">12</span>	      let content = <span class="hljs-string">""</span>;
    <span class="hljs-number">13</span>	      if (event.<span class="hljs-section">state</span>) {
    <span class="hljs-number">14</span>	        content = event.<span class="hljs-section">state</span>.page;
    <span class="hljs-number">15</span>	        this.load(content)
    <span class="hljs-number">16</span>	      }
    <span class="hljs-number">17</span>	    }
    <span class="hljs-number">18</span>	  }
    ...
</code></pre>
<p>We’ve written a new ‘handleBackButton’ function, and we initiate it when the router is initiated. window.onpopstate is part of the HTML5 API, which we can run in this function. When the back button is pressed, the event listener is triggered and we have access to the previous page’s pathname. We can simply feed this to the load function, the same as if we were just clicking a link.</p>
<p>However, if we use the back button consecutively, no changes are registered after the first press, because the load function is immediately updating the pushState again, so we want to disable that from happening. Lets pass the load function a second argument, true (for back button pressed. And then only update pushState when this isn’t the case.</p>
<pre><code>➜  how-to-js-router git:(master) cat -n src/js/delph.js
     <span class="hljs-number">1</span>	<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Delph</span> </span>{
     <span class="hljs-number">2</span>
     <span class="hljs-number">3</span>	  <span class="hljs-keyword">constructor</span>(routes,el,page){
     <span class="hljs-number">4</span>	    <span class="hljs-keyword">this</span>.routes = routes;
     <span class="hljs-number">5</span>	    <span class="hljs-keyword">this</span>.el = el;
     <span class="hljs-number">6</span>	    <span class="hljs-keyword">this</span>.load(page)
     <span class="hljs-number">7</span>	    <span class="hljs-keyword">this</span>.handleBackButton()
     <span class="hljs-number">8</span>	  }
     <span class="hljs-number">9</span>
    <span class="hljs-number">10</span>	  handleBackButton(){
    <span class="hljs-number">11</span>	    <span class="hljs-built_in">window</span>.onpopstate = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-number">12</span>	      <span class="hljs-keyword">let</span> content = <span class="hljs-string">""</span>;
    <span class="hljs-number">13</span>	      <span class="hljs-keyword">if</span> (event.state) {
    <span class="hljs-number">14</span>	        content = event.state.page;
    <span class="hljs-number">15</span>	        <span class="hljs-keyword">this</span>.load(content, <span class="hljs-literal">true</span>)
    <span class="hljs-number">16</span>	      }
    <span class="hljs-number">17</span>	    }
    <span class="hljs-number">18</span>	  }
    <span class="hljs-number">19</span>
    <span class="hljs-number">20</span>	  load(page, backButtonUsed){
    <span class="hljs-number">21</span>	    <span class="hljs-keyword">if</span> (!backButtonUsed){
    <span class="hljs-number">22</span>	      history.pushState({ page}, <span class="hljs-literal">null</span>, <span class="hljs-string">`/<span class="hljs-subst">${page}</span>`</span>);
    <span class="hljs-number">23</span>	    }
</code></pre>
<p>Repo at stage 10: <a href="https://github.com/cerico/how-to-js-router/releases/tag/0.10.1">https://github.com/cerico/how-to-js-router/releases/tag/0.10.1</a></p>
<p>__</p>
<h3>Using Express</h3>
<p>So, our router works in the dev environment, but we don’t want to use webpack in production, we’ll use express. So first we’ll need to install express and path, and create a build script and a production script.</p>
<pre><code>➜  how-to-js-router git:(eleven-express) ✗ cat -n package.json
     ...
      <span class="hljs-number">6</span>	  <span class="hljs-string">"scripts"</span>: {
     <span class="hljs-number">7</span>	    <span class="hljs-string">"dev"</span>: <span class="hljs-string">"webpack-dev-server --config webpack/webpack.config.js --open"</span>,
     <span class="hljs-number">8</span>	    <span class="hljs-string">"build"</span>: <span class="hljs-string">"webpack --config webpack/webpack.prod.config.js"</span>,
     <span class="hljs-number">9</span>	    <span class="hljs-string">"prod"</span>: <span class="hljs-string">"node server.js"</span>
    <span class="hljs-number">10</span>	  },
    ...
    <span class="hljs-number">21</span>	  <span class="hljs-string">"devDependencies"</span>: {
    <span class="hljs-number">22</span>	    <span class="hljs-string">"webpack"</span>: <span class="hljs-string">"^3.5.5"</span>,
    <span class="hljs-number">23</span>	    <span class="hljs-string">"webpack-dev-server"</span>: <span class="hljs-string">"^2.7.1"</span>
    <span class="hljs-number">24</span>	  },
    <span class="hljs-number">25</span>	  <span class="hljs-string">"dependencies"</span>: {
    <span class="hljs-number">26</span>	    <span class="hljs-string">"path"</span>: <span class="hljs-string">"^0.12.7"</span>,
    <span class="hljs-number">27</span>	    <span class="hljs-string">"express"</span>: <span class="hljs-string">"^4.15.3"</span>
    <span class="hljs-number">28</span>	  }
    <span class="hljs-number">29</span>	}
    ...
</code></pre>
<p>Production webpack build is very similar to our existing one</p>
<pre><code>➜  how-to-js-router git:(eleven-express) ✗ cat webpack/webpack<span class="hljs-selector-class">.prod</span><span class="hljs-selector-class">.config</span><span class="hljs-selector-class">.js</span>
</code></pre>
<pre><code><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-params">options</span> =&gt;</span> {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">entry</span>: <span class="hljs-string">'./src/js/index.js'</span>,
    <span class="hljs-attr">output</span>: {
      <span class="hljs-attr">path</span>: path.join(__dirname, <span class="hljs-string">'../'</span>, <span class="hljs-string">'/dist'</span>),
      <span class="hljs-attr">filename</span>: <span class="hljs-string">'bundle.js'</span>,
    }
  }
} 
</code></pre>
<p>We’ll also need to temporaily copy our index.html file into dist, as thats what express is going to serve We need to use path to get an absolute location for the production bundle (in this case, our current directory, then one level up, then dist)</p>
<pre><code>➜  how-<span class="hljs-keyword">to</span>-js-router gi<span class="hljs-variable">t:</span>(eleven-express) ✗ <span class="hljs-keyword">cat</span> server.js
</code></pre>
<pre><code><span class="hljs-keyword">const</span> express = require(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> server = express();

server.use(express.<span class="hljs-keyword">static</span>(<span class="hljs-string">'dist'</span>));
server.<span class="hljs-built_in">listen</span>(<span class="hljs-built_in">process</span>.env.PORT || <span class="hljs-number">5000</span>);
</code></pre>
<p>This serves our production bundle on port 5000 - all good, except it doesn’t handle refresh or direct linking. If we remember back to the dev webpack, we had a historyApiFallback rewrite function, sending all requests initiall to index.html, now we need to do something similar here as well. A package we can use for this is connect-history-api-fallback.</p>
<pre><code>how-<span class="hljs-keyword">to</span>-js-router gi<span class="hljs-variable">t:</span>(dev) ✗ npm install connect-<span class="hljs-keyword">history</span>-api-fallback
</code></pre>
<p>We’ll add this to the server.js file and use it…</p>
<pre><code>➜  how-<span class="hljs-keyword">to</span>-js-router gi<span class="hljs-variable">t:</span>(kstephen) ✗ <span class="hljs-keyword">cat</span> server.js
</code></pre>
<pre><code><span class="hljs-keyword">const</span> express = <span class="hljs-keyword">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> history = <span class="hljs-keyword">require</span>(<span class="hljs-string">'connect-history-api-fallback'</span>)
<span class="hljs-keyword">const</span> server = express();
<span class="hljs-keyword">const</span> staticFileMiddleware = express.<span class="hljs-keyword">static</span>(<span class="hljs-string">'dist'</span>);
server.<span class="hljs-keyword">use</span>(staticFileMiddleware);
server.<span class="hljs-keyword">use</span>(history({
  disableDotRule: <span class="hljs-keyword">true</span>,
  verbose: <span class="hljs-keyword">true</span>
}));
server.<span class="hljs-keyword">use</span>(staticFileMiddleware);
server.listen(process.env.PORT || <span class="hljs-number">5000</span>);
</code></pre>
<hr>
<h3>Handling static assets</h3>
<p>Our HTML files aren’t being bundled, so we’ll need to make sure they are accessible to the production build. So we can add a new npm script ‘copy-files’, which can run every time a build finishes.</p>
<pre><code>➜  how-<span class="hljs-keyword">to</span>-js-router gi<span class="hljs-variable">t:</span>(kstephen) ✗ <span class="hljs-keyword">cat</span> -n package.json
</code></pre>
<pre><code>...
     <span class="hljs-number">6</span>	  <span class="hljs-string">"scripts"</span>: {
     <span class="hljs-number">7</span>	    <span class="hljs-string">"dev"</span>: <span class="hljs-string">"webpack-dev-server --config webpack/webpack.config.js --open"</span>,
     <span class="hljs-number">8</span>	    <span class="hljs-string">"build"</span>: <span class="hljs-string">"webpack --config webpack/webpack.prod.config.js &amp;&amp; npm run copy-files"</span>,
     <span class="hljs-number">9</span>	    <span class="hljs-string">"copy-files"</span>: <span class="hljs-string">"cp src/index.html dist &amp;&amp; cp -r views dist"</span>,
    <span class="hljs-number">10</span>	    <span class="hljs-string">"prod"</span>: <span class="hljs-string">"node server.js"</span>
    <span class="hljs-number">11</span>	  }
    ...
</code></pre>
<p>This will give us the following structure for the production build, and copying these files as part of the build process means we only need to worry about maintaining one set.</p>
<pre><code>➜  how-to-js-router git:(kstephen) ✗ tree dist
dist
├── bundle<span class="hljs-selector-class">.js</span>
├── index<span class="hljs-selector-class">.html</span>
└── views
    ├── default<span class="hljs-selector-class">.html</span>
    ├── glossop<span class="hljs-selector-class">.html</span>
    ├── hereford<span class="hljs-selector-class">.html</span>
    ├── kendal<span class="hljs-selector-class">.html</span>
    └── malton<span class="hljs-selector-class">.html</span>

<span class="hljs-number">1</span> directory, <span class="hljs-number">7</span> files
</code></pre>
<hr>
<h3>Gotchas - File Locations</h3>
<p>Caveat, as we’re only maintaining one set of html files, and copying them from to dist as part of the build process, we have to make sure we remove any reference to ‘src’ in our js files. The views will be at the top level, which in dev with webpack will be the top level of the repo, but in production, ‘dist’ will be the top level, as thats where we are telling node to serve static assets from. This is best illustrated by tree.</p>
<pre><code>➜  how-to-js-router git:(kstephen) ✗ tree | more
.
├── README.md
├── dist
│   ├── bundle.js
│   ├── <span class="hljs-keyword">index</span>.html
│   └── views
│       ├── <span class="hljs-keyword">default</span>.html
│       ├── glossop.html
│       ├── hereford.html
│       ├── kendal.html
│       └── malton.html
...
├── <span class="hljs-keyword">server</span>.js
├── src
│   ├── <span class="hljs-keyword">index</span>.html
│   └── js
│       ├── delph.js
│       ├── <span class="hljs-keyword">index</span>.js
│       ├── page.js
│       └── routes.js
├── views
│   ├── <span class="hljs-keyword">default</span>.html
│   ├── glossop.html
│   ├── hereford.html
│   ├── kendal.html
│   └── malton.html
└── webpack
    ├── webpack.config.js
    └── webpack.prod.config.js
</code></pre>
<p>In both dev and prod, we want to make sure fetch is retrieving from the top level, so here’s where we want to make sure there are no references to ‘src’.</p>
<pre><code>➜  how-to-js-router git:(kstephen) ✗ cat -n src/js/page.js
     1	<span class="hljs-builtin-name">export</span> class<span class="hljs-built_in"> Page </span>{
     2	  constructor(url) {
     3	    this.url = `views/<span class="hljs-variable">${url}</span>.html`;
<span class="hljs-built_in">..</span>.
</code></pre>
<p>Repo at stage 11: <a href="https://github.com/cerico/how-to-js-router/releases/tag/0.11.1">https://github.com/cerico/how-to-js-router/releases/tag/0.11.1</a></p>
<hr>
<h3>Next</h3>
<p>This is fine, but we can do better. We have our html files being retrieved by fetch, outside our man bundle. Wouldn’t it be better if we included them as part of our bundle and bypassed fetch altogether. The answer is yes! Lets do that in part 3, with web components.</p>
<p><a href="../2017-09-11---introducing-web-components/">Part Three</a></p>
</div><div data-reactid="34"><span style="display:inline;" data-reactid="35"><span style="margin-right:8px;line-height:1.5;" data-reactid="36"><a style="color:rgb(158, 171, 179);display:inline-block;" href="/tags/#javascript" data-reactid="37">Javascript</a><span data-reactid="38">,</span></span><span style="margin-right:8px;line-height:1.5;" data-reactid="39"><a style="color:rgb(158, 171, 179);display:inline-block;" href="/tags/#es6" data-reactid="40">ES6</a><span data-reactid="41"></span></span></span><hr style="margin-top:1.07rem;" data-reactid="42"/><p style="margin-bottom:0.33rem;" data-reactid="43"><a href="/about/" data-reactid="44"><img src="https://s3.eu-west-2.amazonaws.com/io1937/ghpages/linkedin.jpg" style="float:left;margin-top:0;margin-bottom:0;margin-right:0.4125rem;width:3.3rem;height:3.3rem;border-radius:50%;border:1px gray solid;" data-reactid="45"/></a><span data-reactid="46"><!-- react-text: 47 -->garethrobertlee<!-- /react-text --><a href="/about/" data-reactid="48"></a></span></p><div data-reactid="49"><div data-reactid="50"><span data-reactid="51"><a href="/" data-reactid="52">Posts | </a><a href="/about/" data-reactid="53">About | </a></span><a href="mailto:garethrobertlee@gmail.com?Subject=Hello" target="blank_" data-reactid="54">Contact</a></div></div></div></div></div></div><script src="/bundle.js?t=1506944411158"></script></body></html>