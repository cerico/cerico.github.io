<!DOCTYPE html>
 <html lang="en"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title data-react-helmet="true">cerico | Let&#x27;s Get Dockerized. Part I</title><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font-size:112.5%;line-height:1.65em;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.8);font-family:Roboto,sans-serif;font-weight:normal;word-wrap:break-word;}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;color:hsla(0,0%,0%,0.8);font-family:Roboto,sans-serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:2.25rem;line-height:2.475rem;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;color:hsla(0,0%,0%,0.8);font-family:Roboto,sans-serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:1.62671rem;line-height:2.475rem;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;color:hsla(0,0%,0%,0.8);font-family:Roboto,sans-serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:1.38316rem;line-height:1.65rem;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;color:hsla(0,0%,0%,0.8);font-family:Roboto,sans-serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.65rem;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;color:hsla(0,0%,0%,0.8);font-family:Roboto,sans-serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:0.85028rem;line-height:1.65rem;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;color:hsla(0,0%,0%,0.8);font-family:Roboto,sans-serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:0.78405rem;line-height:1.65rem;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}ul{margin-left:1.65rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;list-style-position:outside;list-style-image:none;}ol{margin-left:1.65rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;font-size:0.85rem;line-height:1.42;background:hsla(0,0%,0%,0.04);border-radius:3px;overflow:auto;padding:1.65rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;font-size:1rem;line-height:1.65rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}blockquote{margin-left:1.65rem;margin-right:1.65rem;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.65rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}b{font-weight:bold;}strong{font-weight:bold;}dt{font-weight:bold;}th{font-weight:bold;}li{margin-bottom:calc(1.65rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.65rem;margin-bottom:calc(1.65rem / 2);margin-top:calc(1.65rem / 2);}li > ul{margin-left:1.65rem;margin-bottom:calc(1.65rem / 2);margin-top:calc(1.65rem / 2);}code{font-size:0.85rem;line-height:1.65rem;}kbd{font-size:0.85rem;line-height:1.65rem;}samp{font-size:0.85rem;line-height:1.65rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:tnum;padding-left:1.1rem;padding-right:1.1rem;padding-top:0.825rem;padding-bottom:calc(0.825rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}tt,code{background-color:hsla(0,0%,0%,0.04);border-radius:3px;font-family:Consolas,"Roboto Mono","Liberation Mono",Menlo,Courier,monospace;padding:0;padding-top:0.2em;padding-bottom:0.2em;}pre code{background:none;line-height:1.42;}code:before,code:after,tt:before,tt:after{letter-spacing:-0.2em;content:" ";}pre code:before,pre code:after,pre tt:before,pre tt:after{content:"";}</style><link href="//fonts.googleapis.com/css?family=Roboto:400,400i,700" rel="stylesheet" type="text/css"/><style>@import url(https://fonts.googleapis.com/css?family=Raleway);.hljs{display:block;overflow-x:auto;padding:.5em;background:#000;color:#f8f8f8}.hljs-comment,.hljs-quote{color:#aeaeae;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#e28964}.hljs-string{color:#65b042}.hljs-subst{color:#daefa3}.hljs-link,.hljs-regexp{color:#e9c062}.hljs-name,.hljs-section,.hljs-tag,.hljs-title{color:#89bdff}.hljs-class .hljs-title,.hljs-doctag{text-decoration:underline}.hljs-bullet,.hljs-number,.hljs-symbol{color:#3387cc}.hljs-params,.hljs-template-variable,.hljs-variable{color:#3e87e3}.hljs-attribute{color:#cda869}.hljs-meta{color:#8996a8}.hljs-formula{background-color:#0e2231;color:#f8f8f8;font-style:italic}.hljs-addition{background-color:#253b22;color:#f8f8f8}.hljs-deletion{background-color:#420e09;color:#f8f8f8}.hljs-selector-class{color:#9b703f}.hljs-selector-id{color:#8b98ab}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}*{font-family:Georgia,sans-serif}body{background:#fcfcfa;color:#333;font-family:PT Serif,serif;line-height:1.2em;margin:1em auto 4em;max-width:720px;padding:0 18px;position:relative}pre{background:#000;color:#f8f8f8}pre *{font-family:Consolas,Roboto Mono,Liberation Mono,Menlo,Courier,monospace}h1,h2{text-rendering:optimizeLegibility}.topper{font-family:PT Sans,sans-serif;font-size:64px;font-weight:300;letter-spacing:-2px;line-height:1em;margin:.5em 0}a{text-decoration:none;color:#6495ed}.markdown{margin-top:27.2px;margin-top:1.7rem}</style></head><body><div id="react-mount"><div data-reactroot="" data-reactid="1" data-react-checksum="-694315811"><div class="headroom-wrapper" data-reactid="2"><div style="position:relative;top:0;left:0;right:0;z-index:1;-webkit-transform:translateY(0);-ms-transform:translateY(0);transform:translateY(0);" class="headroom headroom--unfixed" data-reactid="3"><a class="topper" href="/" data-reactid="4">cerico</a></div></div><hr style="margin-top:1.07rem;" data-reactid="5"/><p style="margin-bottom:0.33rem;" data-reactid="6"><a href="/about/" data-reactid="7"><img src="https://s3.eu-west-2.amazonaws.com/io1937/ghpages/linkedin.jpg" style="float:left;margin-top:0;margin-bottom:0;margin-right:0.4125rem;width:3.3rem;height:3.3rem;border-radius:50%;border:1px gray solid;" data-reactid="8"/></a><span data-reactid="9"><!-- react-text: 10 -->garethrobertlee<!-- /react-text --><a href="/about/" data-reactid="11"></a></span></p><div data-reactid="12"><div data-reactid="13"><span data-reactid="14"><a href="/" data-reactid="15">Posts | </a><a href="/about/" data-reactid="16">About | </a></span><a href="mailto:garethrobertlee@gmail.com?Subject=Hello" target="blank_" data-reactid="17">Contact</a></div></div><div class="markdown" data-reactid="18"><!-- react-empty: 19 --><h1 data-reactid="20">Let&#x27;s Get Dockerized. Part I</h1><div data-reactid="21"><p>In this series we’re going to look at how to build a fully containerized full stack application running locally and in the cloud. We’re going to use the following.</p>
<ol>
<li>Docker
<ul>
<li>Machine</li>
<li>Compose</li>
</ul>
</li>
<li>Nginx</li>
<li>Clojure</li>
<li>Vanilla JS
<ul>
<li>Webpack</li>
</ul>
</li>
<li>CoreOS</li>
<li>Deployment
<ul>
<li>Exoscale</li>
<li>AWS</li>
<li>Digital Ocean</li>
</ul>
</li>
<li>Ansible</li>
<li>Vagrant</li>
<li>Continuous Integration</li>
</ol>
<p>We will build 3 linked containers, one Javascipt, a second API container with Clojure, and a proxy container running nginx. Using a reverse proxy to connect our two containers means we can run them on separate ports and not have to worry about issues with CORS.</p>
<h2>TLDR / Repo</h2>
<p>Repository is here <a href="https://github.com/institute1937/marsden">https://github.com/institute1937/marsden</a></p>
<h2>Tree</h2>
<p>Lets start by having a look at the project structure.</p>
<pre><code>➜  <span class="hljs-keyword">marsden </span>git:(master) tree 
</code></pre>
<pre><code>
├── Makefile
├── bin
│   ├── aws
│   │   └── deploy<span class="hljs-selector-class">.sh</span>
│   ├── digital_ocean
│   │   └── deploy<span class="hljs-selector-class">.sh</span>
│   ├── exo
│   │   ├── deploy<span class="hljs-selector-class">.sh</span>
│   │   └── provision<span class="hljs-selector-class">.sh</span>
├── client
│   ├── Dockerfile
│   ├── Dockerfile<span class="hljs-selector-class">.dev</span>
│   ├── dist
│   │   └── bundle<span class="hljs-selector-class">.js</span>
│   ├── index<span class="hljs-selector-class">.html</span>
│   ├── node_modules
│   ├── package<span class="hljs-selector-class">.json</span>
│   ├── server<span class="hljs-selector-class">.js</span>
│   ├── src
│   │   ├── css
│   │   │   └── style<span class="hljs-selector-class">.css</span>
│   │   └── js
│   │       └── index<span class="hljs-selector-class">.js</span>
│   ├── webpack<span class="hljs-selector-class">.config</span><span class="hljs-selector-class">.js</span>
│   └── webpack<span class="hljs-selector-class">.prod</span><span class="hljs-selector-class">.config</span><span class="hljs-selector-class">.js</span>
├── clojure
│   ├── Dockerfile
│   ├── src
│   │   └── hidere
│   │       └── core<span class="hljs-selector-class">.clj</span>
├── config
│   ├── mars<span class="hljs-selector-class">.env</span>
│   └── mars<span class="hljs-selector-class">.env</span><span class="hljs-selector-class">.template</span>
├── docker-compose<span class="hljs-selector-class">.prod</span><span class="hljs-selector-class">.yml</span>
├── docker-compose<span class="hljs-selector-class">.yml</span>
└── proxy
    ├── Dockerfile
    ├── default<span class="hljs-selector-class">.conf</span>
    ├── index<span class="hljs-selector-class">.html</span>
    ├── nginx<span class="hljs-selector-class">.conf</span>
    └── sites-enabled
        ├── mars<span class="hljs-selector-class">.conf</span>
        └── mars<span class="hljs-selector-class">.dev</span><span class="hljs-selector-class">.conf</span>
</code></pre>
<p>At the top level of the repo we have the client container, the server container (clojure), and the proxy container. A scripts directory (bin) and a config directory for environment variables. Then we have our main docker-compose files, one for dev and one for production. Finally we have the Makefile, which we’ll use to control the entire project</p>
<h2>Makefile</h2>
<p>Lets start with the Makefile</p>
<pre><code>➜  <span class="hljs-keyword">marsden </span>git:(master) more Makefile
</code></pre>
<pre><code>start:
        docker-compose up

bundle:
        cd<span class="hljs-built_in"> client </span>&amp;&amp; npm <span class="hljs-builtin-name">run</span> build

build:
        docker-compose up --build

deploy-do:
        ./bin/digital_ocean/deploy.sh

deploy-aws:
        ./bin/aws/deploy.sh

deploy-exo:
        ./bin/exo/deploy.sh

</code></pre>
<p>each command is run from terminal as follows.</p>
<pre><code>➜  <span class="hljs-keyword">marsden </span>git:(master) make start
<span class="hljs-symbol">docker</span>-compose up
<span class="hljs-symbol">Recreating</span> <span class="hljs-keyword">marsden_web_1 </span>...
<span class="hljs-symbol">Recreating</span> <span class="hljs-keyword">marsden_clojure_1 </span>...
<span class="hljs-symbol">Recreating</span> <span class="hljs-keyword">marsden_web_1
</span><span class="hljs-symbol">Recreating</span> <span class="hljs-keyword">marsden_web_1 </span>... done
<span class="hljs-symbol">Recreating</span> <span class="hljs-keyword">marsden_nginx_1 </span>...
<span class="hljs-symbol">Recreating</span> <span class="hljs-keyword">marsden_nginx_1 </span>... done
<span class="hljs-symbol">Attaching</span> to <span class="hljs-keyword">marsden_clojure_1, </span><span class="hljs-keyword">marsden_web_1, </span><span class="hljs-keyword">marsden_nginx_1
</span></code></pre>
<p>We’re using the makefile primarily as a front end for docker commands and also for some deployment scripts, which we’ll come to later. For now we’ll just look at start, bundle and build.</p>
<ul>
<li>
<p>Start - This just runs ‘docker-compose up’, which will read the docker-compose.yml</p>
</li>
<li>
<p>Bundle - This will cd into our client container and run npm build, which will use webpack to build a production bundle.</p>
</li>
<li>
<p>Build - We run this if we have added any packages to any of our containers and want to have those included in the build.</p>
</li>
</ul>
<p>Now lets take a look at the docker-compose.yml. This is the docker-compose file we’ll be using in development.</p>
<pre><code>➜  <span class="hljs-selector-tag">marsden</span> <span class="hljs-selector-tag">git</span><span class="hljs-selector-pseudo">:(master)</span> <span class="hljs-selector-tag">more</span> <span class="hljs-selector-tag">docker-compose</span><span class="hljs-selector-class">.yml</span>
</code></pre>
<pre><code><span class="hljs-attribute">version</span>: <span class="hljs-string">"2"</span>
<span class="hljs-attribute">services</span>:

    <span class="hljs-attribute">web</span>:
        <span class="hljs-attribute">build</span>:
          <span class="hljs-attribute">context</span>: ./client
          <span class="hljs-attribute">dockerfile</span>: Dockerfile.dev
        <span class="hljs-attribute">volumes</span>:
          - <span class="hljs-string">"./client:/build"</span>
          - /build/node_modules
        <span class="hljs-attribute">working_dir</span>: /build
        <span class="hljs-attribute">command</span>: <span class="hljs-string">'npm run dev'</span>
        <span class="hljs-attribute">ports</span>:
          - <span class="hljs-number">6800</span>:<span class="hljs-number">5000</span>

    <span class="hljs-attribute">clojure</span>:
        <span class="hljs-attribute">build</span>: ./clojure
        <span class="hljs-attribute">volumes</span>:
          - <span class="hljs-string">"./clojure:/build"</span>
        <span class="hljs-attribute">working_dir</span>: /build
        <span class="hljs-attribute">command</span>: <span class="hljs-string">'lein run'</span>
        <span class="hljs-attribute">ports</span>:
          - <span class="hljs-number">6801</span>:<span class="hljs-number">3009</span>

    <span class="hljs-attribute">nginx</span>:
        <span class="hljs-attribute">build</span>: ./proxy
        <span class="hljs-attribute">ports</span>:
            - <span class="hljs-string">"3100:3100"</span>
        <span class="hljs-attribute">links</span>:
            - web
            - clojure

</code></pre>
<p>A straightforward file, with 3 services - or containers. Web, Clojure, and Nginx. Let’s run through each of the components in each container.</p>
<ul>
<li>
<p>build</p>
<ul>
<li>If we only had one container we might keep eveything in the top level, but we have 3, client, clojure and proxy. As we will see shortly, each of these has its own Dockerfile, so in each container we build one level down. For the web/client container we’re specifying a particular dockerfile, so we need to pass the build section the dockerfile name as well.</li>
</ul>
</li>
<li>
<p>volumes</p>
<ul>
<li>This is only present in the client container. We’ll mount our client container on a /build directory (this is created in the clients Dockerfile, and we’ll see that in the next post. We also have node_modules under the build directory for all the js packages.</li>
</ul>
</li>
<li>
<p>working_dir / command</p>
<ul>
<li>We’re specifiying the /build directory as our client root to run our launch command - ‘npm run dev’. This will read the package.json file which is at the top level and mapped with the volume section.</li>
</ul>
</li>
<li>
<p>ports</p>
<ul>
<li>This is a mapping of the ports running inside the container to the ones we will access it from on the ‘outside’. If we were to cd into the client container and run ‘npm run dev’, eg bypassing docker altogether, then our client app would be available on port 1998. Running via docker-compose up (or make start) this is mapped to port 6800, which is where we’ll access it in the browser.</li>
<li>The clojure app runs on 3009 internally and 6801 with docker.</li>
</ul>
</li>
<li>
<p>links</p>
<ul>
<li>This is our reverse proxy. It links both our containers together, this means the front and back can access each other without needing to worry about CORS issues. It also means we don’t need to handle CORS inside the Clojure app, nginx will do that for us. As this is our dev docker-compose we’ll be using 3100 not 80 or 443.</li>
</ul>
</li>
</ul>
<p>Up next!</p>
<p>In the next section we’ll look at the Dockerfiles for each of the containers</p>
</div></div></div></div><script src="/bundle.js?t=1503428385874"></script></body></html>